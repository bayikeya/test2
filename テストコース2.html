<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>複数画像切替付きスポット案内</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background-color: #000; 
      color: white; 
      font-family: sans-serif; 
      text-align: center; 
    }
    #camera { 
      width: 100vw; 
      height: 100vh; 
      object-fit: cover; 
      position: absolute; 
      top: 0; 
      left: 0; 
      z-index: -1; 
    }
    #info { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      background: rgba(0,0,0,0.6); 
      padding: 10px; 
      border-radius: 8px; 
      z-index: 1; 
      white-space: pre-wrap; 
    }
    #image {
      position: absolute;
      bottom: 180px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 300px;
      object-fit: contain;
      display: none;
      z-index: 1;
      background: black;
    }
    .btn { 
      position: absolute; 
      left: 50%; 
      transform: translateX(-50%); 
      background-color: #007BFF; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      font-size: 14px; 
      border-radius: 8px; 
      cursor: pointer; 
      z-index: 2; 
      display: none; 
    }
    #playBtn { bottom: 120px; }
    #patternBtn { bottom: 70px; }
    #nextBtn { bottom: 20px; }
    .img-nav { 
      position: absolute; 
      bottom: 260px; 
      z-index: 2; 
      font-size: 20px; 
      background: rgba(0,0,0,0.5); 
      color: white; 
      border: none; 
      padding: 5px 15px; 
      cursor: pointer; 
      border-radius: 6px; 
    }
    #prevBtn { left: 10%; }
    #nextImgBtn { right: 10%; }
  </style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div id="info">位置情報取得中...</div>
<img id="image" src="" alt="スポット画像" />
<button class="btn" id="playBtn" onclick="toggleAudio()">音声案内を再生</button>
<button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
<button class="btn" id="nextBtn" onclick="goToNextSpot()">このスポットは完了</button>
<button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">←</button>
<button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">→</button>
<audio id="audio" src=""></audio>

<script>
const spots = [
  {
    name: "13号館前",
    lat: 35.69304350697483,
    lon: 140.05084706907195,
    radius: 0,
    images: ["image0.jpeg", "image1.jpeg"],
    audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" }
  },
  {
    name: "曲がり角左１",
    lat: 35.693237099346376,
    lon: 140.0510123108731,
    radius: 10,
    images: ["image2.jpeg", "image10.jpeg"],
    audio: { A: "spot2.ja.mp3", B: "spot2.en.mp3", C: "spot2.ch.mp3" }
  },
  {
    name: "曲がり角右１",
    lat: 35.6933688901654,
    lon: 140.05042624826697,
    radius: 10,
    images: ["image3.jpeg", "image11.jpeg"],
    audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" }
  },
  {
    name: "曲がり角右２",
    lat: 35.69384574273443,
    lon: 140.05039255315654,
    radius: 10,
    images: ["image4.jpeg", "image13.jpeg"],
    audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" }
  },
  {
    name: "曲がり角右３",
    lat: 35.69386114596397,
    lon: 140.0510468829086,
    radius: 10,
    images: ["image5.jpeg", "image14.jpeg"],
    audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" }
  },
  {
    name: "曲がり角右４",
    lat: 35.69339288645685,
    lon: 140.0510468829086,
    radius: 10,
    images: ["image6.jpeg", "image15.jpeg"],
    audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" }
  },
  {
    name: "曲がり角左２",
    lat: 35.69337440247251,
    lon: 140.0504285887079,
    radius: 10,
    images: ["image7.jpeg", "image16.jpeg"],
    audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" }
  },
  {
    name: "曲がり角左３",
    lat: 35.692982445978856,
    lon: 140.0502512817421,
    radius: 10,
    images: ["image8.jpeg", "image17.jpeg"],
    audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" }
  },
  {
    name: "目的地",
    lat: 35.69285055749237,
    lon: 140.05080838028817,
    radius: 10,
    images: ["image9.jpeg", "image18.jpeg"],
    audio: { A: "spot9.ja.mp3", B: "spot9.en.mp3", C: "spot9.ch.mp3" }
  }
];

let currentIndex = 0;
let hasEnteredSpot = false;
let currentSpot = null;
let isPlaying = false;
let currentPattern = "A";
let imageIndex = 0;

// --- スムージング（中央値で外れ値に強い） ---
let latHistory = [], lonHistory = [];
function median(values) {
  if (!values.length) return null;
  values.sort((a,b)=>a-b);
  const mid = Math.floor(values.length/2);
  return values.length % 2 ? values[mid] : (values[mid-1]+values[mid])/2;
}
function smoothPosition(lat, lon) {
  latHistory.push(lat); lonHistory.push(lon);
  if (latHistory.length > 7) { latHistory.shift(); lonHistory.shift(); }
  return { lat: median([...latHistory]), lon: median([...lonHistory]) };
}

const camera = document.getElementById("camera");
const info = document.getElementById("info");
const image = document.getElementById("image");
const playBtn = document.getElementById("playBtn");
const nextBtn = document.getElementById("nextBtn");
const patternBtn = document.getElementById("patternBtn");
const audio = document.getElementById("audio");
const prevBtn = document.getElementById("prevBtn");
const nextImgBtn = document.getElementById("nextImgBtn");

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
  .then(stream => camera.srcObject = stream)
  .catch(err => alert("カメラへのアクセスに失敗しました: " + err));

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function checkProximity(lat, lon) {
  if (currentIndex >= spots.length) {
    info.innerText = "すべてのスポットを通過しました。";
    hideAllUI();
    return;
  }

  const spot = spots[currentIndex];
  const distance = getDistance(lat, lon, spot.lat, spot.lon);
  const range = spot.radius || 10;

  info.innerText =
    `現在地: 緯度 ${lat.toFixed(6)}, 経度 ${lon.toFixed(6)}\n` +
    `次のスポット: ${spot.name}（${currentIndex + 1} / ${spots.length}）\n` +
    `残り距離: ${distance.toFixed(1)}m`;

  if (currentIndex >= 1 && !hasEnteredSpot && distance < range) {
    showSpot(spot);
  }
}

function showSpot(spot) {
  currentSpot = spot;
  hasEnteredSpot = true;
  imageIndex = 0;

  audio.src = spot.audio[currentPattern];
  image.src = spot.images[imageIndex];
  image.style.display = "block";
  playBtn.style.display = "block";
  nextBtn.style.display = "block";
  patternBtn.style.display = "block";
  prevBtn.style.display = spot.images.length > 1 ? "block" : "none";
  nextImgBtn.style.display = spot.images.length > 1 ? "block" : "none";
  playBtn.innerText = isPlaying ? "音声を停止" : "音声案内を再生";
  updatePatternButtonText();
}

function toggleAudio() {
  if (!currentSpot) return;
  if (!isPlaying) {
    audio.play().catch(e => alert("音声再生に失敗: " + e));
    isPlaying = true;
    playBtn.innerText = "音声を停止";
  } else {
    audio.pause();
    isPlaying = false;
    playBtn.innerText = "音声案内を再生";
  }

  audio.onended = () => {
    if (isPlaying) {
      setTimeout(() => {
        if (isPlaying) {
          audio.currentTime = 0;
          audio.play();
        }
      }, 1000);
    }
  };
}

function switchPattern() {
  const patterns = ["A", "B", "C"];
  const index = patterns.indexOf(currentPattern);
  currentPattern = patterns[(index + 1) % patterns.length];
  updatePatternButtonText();

  if (currentSpot) {
    const newAudio = currentSpot.audio[currentPattern];
    const wasPlaying = isPlaying;
    audio.pause();
    isPlaying = false;
    audio.src = newAudio;
    playBtn.innerText = "音声案内を再生";
    if (wasPlaying) {
      audio.play();
      isPlaying = true;
      playBtn.innerText = "音声を停止";
    }
  }
}

function showPrevImage() {
  if (!currentSpot) return;
  imageIndex = (imageIndex - 1 + currentSpot.images.length) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}

function showNextImage() {
  if (!currentSpot) return;
  imageIndex = (imageIndex + 1) % currentSpot.images.length;
  image.src = currentSpot.images[imageIndex];
}

function updatePatternButtonText() {
  let label = "";
  switch (currentPattern) {
    case "A": label = "English"; break;
    case "B": label = "中文"; break;
    case "C": label = "日本語"; break;
  }
  patternBtn.innerText = label;
}

function goToNextSpot() {
  if (isPlaying) {
    audio.pause();
    isPlaying = false;
  }
  currentIndex++;
  hasEnteredSpot = false;
  currentSpot = null;
  hideAllUI();
}

function hideAllUI() {
  image.style.display = "none";
  playBtn.style.display = "none";
  nextBtn.style.display = "none";
  patternBtn.style.display = "none";
  prevBtn.style.display = "none";
  nextImgBtn.style.display = "none";
}

// --- GPS取得部分を改良 ---
if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    pos => {
      if (pos.coords.accuracy > 15) return; // 誤差15m以上は無視
      const smoothed = smoothPosition(pos.coords.latitude, pos.coords.longitude);
      checkProximity(smoothed.lat, smoothed.lon);
    },
    err => info.innerText = "位置情報の取得に失敗しました",
    { enableHighAccuracy: true, maximumAge: 0, timeout: 2000 } // 高精度＆超高頻度
  );
}

window.onload = () => {
  showSpot(spots[0]);
};
</script>

</body>
</html>
